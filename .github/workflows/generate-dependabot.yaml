# Centrally managed file, do not modify this directly. Source: https://github.com/FlyrInc/terraform-tfe-cloud/tree/main/terraform-github/repository-files/files
# PR's created from this workflow won't trigger PR workflows due to https://github.com/orgs/community/discussions/65321#discussioncomment-8003574

name: Generate dependabot.yaml file
on:
  schedule:
    - cron: "0 15 15 * *"
  workflow_dispatch:
jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Print Standard Header
        run: |
          cat <<-'EOF' > .github/dependabot.yaml
          version: 2
          registries:
            terraform-cloud:
              type: "terraform-registry"
              url: "https://app.terraform.io"
              token: ${{ '${{ secrets.TERRAFORM_CLOUD }}' }}
          updates:
            - package-ecosystem: "github-actions"
              directory: "/"
              registries: "*" # Does not make sense, but at least one update must reference each registry
              schedule:
                interval: "monthly"
      - name: Generate Terraform Body
        run: |
          MODULES=$(find . -name \*.tf -printf '%h\n' | sort | uniq | jq -R -s -c 'split("\n")[:-1]')
          jq -r '.[]' <<< "$MODULES" | sort | while read MODULE; do
          cat <<EOF >> .github/dependabot.yaml
            - directory: "${MODULE#./}"
              package-ecosystem: "terraform"
              registries: ["terraform-cloud"]
              schedule:
                interval: "monthly"
              groups:
                $(basename ${MODULE}):
                  patterns: ["*"]
          EOF
          done
      - name: Generate Golang Body
        run: |
          PACKAGES=$(find . -name go.mod -printf '%h\n' | sort | uniq | jq -R -s -c 'split("\n")[:-1]')
          jq -r '.[]' <<< "$PACKAGES" | sort | while read PACKAGE; do
          cat <<EOF >> .github/dependabot.yaml
            - directory: "${PACKAGE#./}"
              package-ecosystem: "gomod"
              schedule:
                interval: "monthly"
              rebase-strategy: "disabled"
              groups:
                minor:
                  patterns: ["*"]
                  update-types: [ "minor", "patch" ]
          EOF
          done
      - name: Generate Docker Body
        run: |
          PACKAGES=$(find . -name '*Dockerfile*' -printf '%h\n' | sort | uniq | jq -R -s -c 'split("\n")[:-1]')
          jq -r '.[]' <<< "$PACKAGES" | sort | while read PACKAGE; do
          cat <<EOF >> .github/dependabot.yaml
            - directory: "${PACKAGE#./}"
              package-ecosystem: "docker"
              schedule:
                interval: "weekly"
              groups:
                minor:
                  patterns: ["*"]
                  update-types: [ "minor", "patch" ]
                major:
                  patterns: ["*"]
                  update-types: ["major"]
          EOF
          done
      - name: Print new.github/dependabot.yaml
        run: cat .github/dependabot.yaml
      - name: Set pull-request variables
        id: pr-vars
        run: |
          echo pr_body="Due to https://github.com/orgs/community/discussions/65321 one needs to close then open PR to trigger worflows" >> $GITHUB_OUTPUT
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: Auto update .github/dependabot.yaml
          branch: dependabot-yaml
          title: '[Github Actions] Update generated dependabot.yaml'
          body: ${{ steps.pr-vars.outputs.pr_body }}
          labels: dependabot, terraform
          add-paths: .github/dependabot.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
# For grouped updates, need to make sure the group name is not "." which happens when
# tf files in the root dir.
